---
title: "data_wrangling"
author: "Zechariah Meunier"
date: '`r Sys.Date()`'
output: html_document
---

```{r}
library(tidyverse)
library(JuliaCall)
source("../src/emude.R")
source("../src/data_wrangling.R")
```

```{r}
julia_setup(JULIA_HOME = "C:/Users/zdmeu/AppData/Local/Programs/Julia-1.9.3/bin")
  JuliaCall::julia_library("UniversalDiffEq")

#ude<-emude_setup()
```


# Test data relativization functions

Simulate data for six species with some missing values
```{r}
set.seed(23)

df <- tibble(
  #moderate NAs, values from 0 to 150
  Species_A = sample(c(0:150, NA), 50, replace = TRUE, prob = c(rep(1/200, 151), 0.245)), 
  #no NAs, values from 0 to 150
  Species_B = sample(c(0:150, NA), 50, replace = TRUE, prob = c(rep(1/151, 151), 0)), 
  #many NAs, values from 0 to 100
  Species_C = sample(c(0:100, NA), 50, replace = TRUE, prob = c(rep(1/250, 101), 0.596)),
  #moderate NAs, values from 0 to 20
  Species_D = sample(c(0:20, NA), 50, replace = TRUE, prob = c(rep(1/30, 21), 0.3)), 
  #no NAs, values from 0 to 20
  Species_E = sample(c(0:20, NA), 50, replace = TRUE, prob = c(rep(1/21, 21), 0)), 
  #many NAs, values from 2 to 20
  Species_F = sample(c(2:20, NA), 50, replace = TRUE, prob = c(rep(1/250, 19), 0.396))
)

table(is.na(df$Species_A))
table(is.na(df$Species_B))
table(is.na(df$Species_C))
table(is.na(df$Species_D))
table(is.na(df$Species_E))
table(is.na(df$Species_F))
```

Test column maximum and column minimum functions
```{r}
colmax(df)
max(df$Species_A, na.rm = T)
max(df$Species_B, na.rm = T)
max(df$Species_C, na.rm = T)
max(df$Species_D, na.rm = T)
max(df$Species_E, na.rm = T)
max(df$Species_F, na.rm = T)

colmin(df)
min(df$Species_A, na.rm = T)
min(df$Species_B, na.rm = T)
min(df$Species_C, na.rm = T)
min(df$Species_D, na.rm = T)
min(df$Species_E, na.rm = T)
min(df$Species_F, na.rm = T)
```

Test relativization by column maximum
```{r}
df_colmax <- rel_colmax(df)

plot(x=df$Species_A, df_colmax$Species_A)
abline(a = 0, b = 1/max(df$Species_A, na.rm = T), col = "red", lty = 2)

plot(x=df$Species_B, df_colmax$Species_B)
abline(a = 0, b = 1/max(df$Species_B, na.rm = T), col = "red", lty = 2)

plot(x=df$Species_C, df_colmax$Species_C)
abline(a = 0, b = 1/max(df$Species_C, na.rm = T), col = "red", lty = 2)

plot(x=df$Species_D, df_colmax$Species_D)
abline(a = 0, b = 1/max(df$Species_D, na.rm = T), col = "red", lty = 2)

plot(x=df$Species_E, df_colmax$Species_E)
abline(a = 0, b = 1/max(df$Species_E, na.rm = T), col = "red", lty = 2)

plot(x=df$Species_F, df_colmax$Species_F)
abline(a = 0, b = 1/max(df$Species_F, na.rm = T), col = "red", lty = 2)
```

Test relativization by minimum-maximum
```{r}
df_minmax <- rel_minmax(df)

plot(x=df$Species_A, df_minmax$Species_A) 
plot(x=df$Species_B, df_minmax$Species_B)
plot(x=df$Species_C, df_minmax$Species_C)
plot(x=df$Species_D, df_minmax$Species_D)
plot(x=df$Species_E, df_minmax$Species_E)
plot(x=df$Species_F, df_minmax$Species_F)
```

Compare the relativizations
```{r}
plot(x=df_colmax$Species_A, df_minmax$Species_A)
abline(a = 0, b = 1, col = "red", lty = 2)
plot(x=df_colmax$Species_B, df_minmax$Species_B)
abline(a = 0, b = 1, col = "red", lty = 2)
plot(x=df_colmax$Species_C, df_minmax$Species_C)
abline(a = 0, b = 1, col = "red", lty = 2)
plot(x=df_colmax$Species_D, df_minmax$Species_D)
abline(a = 0, b = 1, col = "red", lty = 2)
plot(x=df_colmax$Species_E, df_minmax$Species_E)
abline(a = 0, b = 1, col = "red", lty = 2)
plot(x=df_colmax$Species_F, df_minmax$Species_F)
abline(a = 0, b = 1, col = "red", lty = 2)
```

# Test error messages

Simulate time series
```{r}
ts1 = tibble("t" = seq(1:25), "value" = c(-3,0.4,0.8,rep(0.1,20),0.16,3))
ts2 = tibble("t" = c(1,2,3,4,5), "value" = c(2,4,8,16,99))
```

Test NODE function
```{r}
NODE(data=ts1,
     time_column_name = "t")
```

Test ode_model function
```{r}
ode_model(data=ts1,
          derivs = "derivs_from_r.jl",
          initial_parameters = list(r=0.5, b=0.5),
          time_column_name = "t")
```

Test custom_derivatives function
```{r}
custom_derivatives(data=ts2,
                   derivs = "derivs_from_r.jl",
                   initial_parameters = list(r=0.5, b=0.5),
                   time_column_name = "t")
```