


```{r}
julia_setup(JULIA_HOME = '/Applications/Julia-1.10.app/Contents/Resources/julia/bin')
```

```{r setup}
library(tidyverse)
library(JuliaCall)
setwd("../")
source("R/emude.R")
source("R/model_constructors.R")
source("R/model_testing.R")
source("R/training_functions.R")
source("R/helpers.R")
source("R/model_analysis.R")
```

```{r}
#ude <- emude_setup()
julia_library("UniversalDiffEq")
```


```{r}
data = data.frame(
t = c(1.0,2.0,3.0,4.0,5.0,6.0,7.0,8.0,9.0,10.0), 
x = c(1.0,2.0,3.0,4.0,5.0,6.0,7.0,8.0,9.0,10.0) , 
y = c(2.0,4.0,8.0,16.0,32.0,64.0,128.0,256.0,512.0,1024.0)/1000
)
X= data.frame(
  t = c(1.0,2.0,3.0,4.0,5.0,6.0,7.0,8.0,9.0,10.0),
  X = rnorm(10))

NODE_model <- NODE(data=data)
rhs <- get_right_hand_side(NODE_model)
u <- c(1,2)
t <- 0.0
rhs(u,t)
```

```{r}


```
```{r}
rhs(c(1,2),0.0)

```

```{r}
predict(model,data)

#predict(NODE_model, data)
  
#julia_assign("plot", plot)

#julia_eval("plot(plot)")
```

```{r}
julia_library("Random")
julia_library("Lux")
julia_library("ComponentArrays")
julia_library("DataFrames")
```


```{r}
#predict(UDE = model, test_data = data)

julia_eval("Random.seed!(5)")
julia_eval("rng = Random.default_rng()")
julia_eval("NN = Lux.Chain(Lux.Dense( 2 => 10, tanh), Lux.Dense( 10 => 10, tanh),Lux.Dense(10 => 2))")
julia_eval("NNparams, NNstates =Lux.setup(rng, NN)")
julia_eval("NNparams = NNparams |> ComponentArray")

julia_eval("include(\"./derivs_from_r.jl\")")

julia_eval("f_julia = derivs")

julia_eval("function dudt!(du,u, p,t) x,y = u; du .= NN([x,y], p , NNstates)[1]end")

julia_eval("data = DataFrame(t = [1.0,2.0,3.0,4.0,5.0], value1 = [2.0,4.0,6.0,8.0,10.0], value2=[1.0,2.0,3.0,4.0,5.0])")

julia_eval("model=CustomDerivatives(data,f_julia,NNparams)")

julia_eval("testdata = DataFrame(t = [6.0,7.0,8.0], value1=[12.0,14.0,16.0], value2=[6.0,7.0,8.0])")
julia_eval("predict(model, testdata)")
```

uid = gsub(x=format(Sys.time(), "%Y%m%d%H%M%OS6"),pattern = "[.]",replacement="")
test_ID <- paste0("test_data_",uid)
print(test_ID)
  julia_assign(test_ID, data)
  julia_eval(paste0("return(typeof(",test_ID,"))"))
```

